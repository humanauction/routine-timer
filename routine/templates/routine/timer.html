{% extends "base.html" %}
{% load static %}

{% block title %}Timer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'routine/css/timer.css' %}" />
{% endblock %}

{% block content %}
<div class="timer-container">
    <h1>Routine Timer</h1>
    
    <!-- Timer Display -->
    <div class="timer-display">
        <div class="current-task">
            <h2 id="task-name">Get Ready...</h2>
            <div class="task-duration">
                <span id="minutes">00</span>:<span id="seconds">00</span>
            </div>
        </div>
        
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        
        <div class="timer-info">
            <div class="info-item">
                <span class="info-label">Total Time:</span>
                <span id="total-time" class="info-value">0 minutes</span>
            </div>
            <div class="info-item">
                <span class="info-label">Tasks:</span>
                <span id="task-count" class="info-value">0 tasks</span>
            </div>
            <div class="info-item">
                <span class="info-label">Current:</span>
                <span id="current-task-number" class="info-value">0/0</span>
            </div>
        </div>
    </div>
    
    <!-- Timer Controls -->
    <div class="timer-controls">
        <button id="start-btn" class="btn btn-primary">
            <i class="fas fa-play"></i> Start
        </button>
        <button id="pause-btn" class="btn btn-secondary" disabled>
            <i class="fas fa-pause"></i> Pause
        </button>
        <button id="skip-btn" class="btn btn-info" disabled>
            <i class="fas fa-forward"></i> Skip
        </button>
        <button id="reset-btn" class="btn btn-danger" disabled>
            <i class="fas fa-redo"></i> Reset
        </button>
    </div>
    
    <!-- Upcoming Tasks -->
    <div class="upcoming-tasks">
        <h3>Upcoming Tasks</h3>
        <ul id="upcoming-tasks-list" class="tasks-list">
            <li class="empty-message">No tasks in queue</li>
        </ul>
    </div>
    
    <!-- Completed Tasks -->
    <div class="completed-tasks">
        <h3>Completed Tasks</h3>
        <ul id="completed-tasks-list" class="tasks-list">
            <li class="empty-message">No tasks completed</li>
        </ul>
    </div>
</div>

<!-- Sound files -->
<audio id="task-complete-sound" src="{% static 'sounds/complete.mp3' %}" preload="auto"></audio>
<audio id="timer-finish-sound" src="{% static 'sounds/finish.mp3' %}" preload="auto"></audio>

<!-- Timer script -->
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Timer elements
    const minutesEl = document.getElementById('minutes');
    const secondsEl = document.getElementById('seconds');
    const taskNameEl = document.getElementById('task-name');
    const progressBar = document.getElementById('progress-bar');
    const totalTimeEl = document.getElementById('total-time');
    const taskCountEl = document.getElementById('task-count');
    const currentTaskNumberEl = document.getElementById('current-task-number');
    const upcomingTasksList = document.getElementById('upcoming-tasks-list');
    const completedTasksList = document.getElementById('completed-tasks-list');
    
    // Control buttons
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const skipBtn = document.getElementById('skip-btn');
    const resetBtn = document.getElementById('reset-btn');
    
    // Sound effects
    const taskCompleteSound = document.getElementById('task-complete-sound');
    const timerFinishSound = document.getElementById('timer-finish-sound');
    
    // Timer state
    let timer;
    let isPaused = true;
    let totalSeconds = 0;
    let currentSeconds = 0;
    let tasks = [];
    let currentTaskIndex = -1;
    let totalDuration = 0;
    
    // Load routine tasks if they exist in session
    function loadTasks() {
        // For now, fetch from an API endpoint or use example data
        fetch('{% url "routine:get_current_tasks" %}')
            .then(response => response.json())
            .then(data => {
                if (data.tasks && data.tasks.length > 0) {
                    tasks = data.tasks;
                    totalDuration = data.total || 0;
                    updateTasksDisplay();
                } else {
                    // Example data if no tasks are found
                    tasks = [
                        { task: 'Wake up', duration: 3 },
                        { task: 'evacuate', duration: 2 },
                        { task: 'quick break', duration: 5 },
                        { task: 'Coolwater by Davidoff', duration: 2 }
                    ];
                    totalDuration = tasks.reduce((sum, task) => sum + task.duration, 0);
                    updateTasksDisplay();
                }
            })
            .catch(error => {
                console.error('Error loading tasks:', error);
                // Use example data if fetch fails
                tasks = [
                    { task: 'Wake up', duration: 3 },
                    { task: 'evacuate', duration: 2 },
                    { task: 'quick break', duration: 5 },
                    { task: 'Coolwater by Davidoff', duration: 2 }
                ];
                totalDuration = tasks.reduce((sum, task) => sum + task.duration, 0);
                updateTasksDisplay();
            });
    }
    
    // Update the tasks display
    function updateTasksDisplay() {
        // Update info panel
        totalTimeEl.textContent = `${totalDuration} minutes`;
        taskCountEl.textContent = `${tasks.length} tasks`;
        currentTaskNumberEl.textContent = currentTaskIndex >= 0 ? `${currentTaskIndex + 1}/${tasks.length}` : '0/0';
        
        // Update upcoming tasks list
        upcomingTasksList.innerHTML = '';
        if (currentTaskIndex < tasks.length - 1) {
            for (let i = currentTaskIndex + 1; i < tasks.length; i++) {
                const task = tasks[i];
                const li = document.createElement('li');
                li.className = 'task-item';
                li.innerHTML = `
                    <span class="task-name">${task.task}</span>
                    <span class="task-duration">${task.duration} min</span>
                `;
                upcomingTasksList.appendChild(li);
            }
        } else if (tasks.length > 0 && currentTaskIndex === -1) {
            // Show all tasks as upcoming when not started
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'task-item';
                li.innerHTML = `
                    <span class="task-name">${task.task}</span>
                    <span class="task-duration">${task.duration} min</span>
                `;
                upcomingTasksList.appendChild(li);
            });
        } else {
            upcomingTasksList.innerHTML = '<li class="empty-message">No tasks in queue</li>';
        }
        
        // Update completed tasks list
        completedTasksList.innerHTML = '';
        if (currentTaskIndex >= 0) {
            for (let i = 0; i < currentTaskIndex; i++) {
                const task = tasks[i];
                const li = document.createElement('li');
                li.className = 'task-item completed';
                li.innerHTML = `
                    <span class="task-name">${task.task}</span>
                    <span class="task-duration">${task.duration} min</span>
                    <span class="check-icon"><i class="fas fa-check-circle"></i></span>
                `;
                completedTasksList.appendChild(li);
            }
        }
        if (completedTasksList.children.length === 0) {
            completedTasksList.innerHTML = '<li class="empty-message">No tasks completed</li>';
        }
    }
    
    // Format time as MM:SS
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return {
            minutes: mins < 10 ? `0${mins}` : mins,
            seconds: secs < 10 ? `0${secs}` : secs
        };
    }
    
    // Update timer display
    function updateTimerDisplay() {
        const formatted = formatTime(currentSeconds);
        minutesEl.textContent = formatted.minutes;
        secondsEl.textContent = formatted.seconds;
        
        // Update progress bar
        if (currentTaskIndex >= 0 && currentTaskIndex < tasks.length) {
            const taskDuration = tasks[currentTaskIndex].duration * 60;
            const progress = 100 - ((currentSeconds / taskDuration) * 100);
            progressBar.style.width = `${progress}%`;
        } else {
            progressBar.style.width = '100%';
        }
    }
    
    // Start next task
    function startNextTask() {
        currentTaskIndex++;
        
        if (currentTaskIndex < tasks.length) {
            // Start next task
            const task = tasks[currentTaskIndex];
            taskNameEl.textContent = task.task;
            currentSeconds = task.duration * 60;
            updateTimerDisplay();
            updateTasksDisplay();
        } else {
            // All tasks complete
            finishRoutine();
        }
    }
    
    // Task complete
    function completeCurrentTask() {
        if (currentTaskIndex >= 0 && currentTaskIndex < tasks.length) {
            try {
                taskCompleteSound.play();
            } catch (e) {
                console.log('Could not play sound', e);
            }
            startNextTask();
        }
    }
    
    // Finish all tasks
    function finishRoutine() {
        clearInterval(timer);
        taskNameEl.textContent = 'Complete!';
        minutesEl.textContent = '00';
        secondsEl.textContent = '00';
        progressBar.style.width = '100%';
        
        // Update controls
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        skipBtn.disabled = true;
        resetBtn.disabled = false;
        
        // Update display
        currentTaskIndex = tasks.length;
        updateTasksDisplay();
        
        try {
            timerFinishSound.play();
        } catch (e) {
            console.log('Could not play sound', e);
        }
        
        // Show completion message
        alert('Congratulations! You have completed all tasks.');
    }
    
    // Start timer
    function startTimer() {
        if (isPaused) {
            isPaused = false;
            
            if (currentTaskIndex === -1) {
                startNextTask();
            }
            
            timer = setInterval(() => {
                if (currentSeconds > 0) {
                    currentSeconds--;
                    updateTimerDisplay();
                } else {
                    completeCurrentTask();
                }
            }, 1000);
            
            // Update controls
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            skipBtn.disabled = false;
            resetBtn.disabled = false;
        }
    }
    
    // Pause timer
    function pauseTimer() {
        if (!isPaused) {
            clearInterval(timer);
            isPaused = true;
            
            // Update controls
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            skipBtn.disabled = false;
            resetBtn.disabled = false;
        }
    }
    
    // Skip current task
    function skipTask() {
        if (currentTaskIndex >= 0 && currentTaskIndex < tasks.length) {
            completeCurrentTask();
        }
    }
    
    // Reset timer
    function resetTimer() {
        clearInterval(timer);
        isPaused = true;
        currentTaskIndex = -1;
        taskNameEl.textContent = 'Get Ready...';
        minutesEl.textContent = '00';
        secondsEl.textContent = '00';
        progressBar.style.width = '100%';
        
        // Update controls
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        skipBtn.disabled = true;
        resetBtn.disabled = true;
        
        updateTasksDisplay();
    }
    
    // Event listeners
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    skipBtn.addEventListener('click', skipTask);
    resetBtn.addEventListener('click', resetTimer);
    
    // Initialize
    loadTasks();
    resetTimer();
});
</script>
{% endblock %}