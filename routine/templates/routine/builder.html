{% extends "base.html" %}
{% load static %}

{% block title %}Routine Builder - Routine Timer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'routine/css/builder.css' %}" />
{% endblock %}

{% block content %}
<div class="routine-builder">
    <div class="builder-header">
        <h1>Routine Builder</h1>
        <p>Create and customize your routine. Add tasks with specific durations.</p>
    </div>
    
    <!-- Live preview section -->
    <div class="live-preview">
        <h2>Preview</h2>
        <div class="preview-header">
            <div class="preview-name">
                Routine: <span id="preview-routine-name">{{ routine_name|default:"New Routine" }}</span>
            </div>
            <div class="preview-total">
                Total Duration: <span id="preview-total-duration">{{ total_duration|default:0 }}</span> minutes
            </div>
        </div>
        
        <div class="preview-tasks" id="preview-tasks">
            {% if tasks %}
                {% for task in tasks %}
                <div class="preview-task" data-task-id="{{ forloop.counter }}">
                    <span class="task-number">{{ forloop.counter }}.</span>
                    <span class="task-name">{{ task.task }}</span>
                    <span class="task-duration">{{ task.duration }} min</span>
                    <button type="button" class="btn-remove-task" onclick="removeTask({{ forloop.counter0 }})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <div class="preview-empty">
                    <p>No tasks added yet. Add your first task below!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Add task form -->
    <div class="add-task">
        <h3>Add Tasks</h3>
        <form id="task-form" method="post" action="{% url 'routine:builder' %}" class="task-form">
            {% csrf_token %}
            
            <!-- Routine name input -->
            <div class="form-group">
                <label for="routine-name">Routine Name:</label>
                <input 
                    type="text" 
                    name="routine_name" 
                    placeholder="Enter routine name" 
                    id="routine-name" 
                    value="{{ routine_name }}" 
                    required 
                    autocomplete="off"
                />
            </div>
            
            <!-- Task input -->
            <div class="form-group">
                {{ form.task.label_tag }} 
                {{ form.task }} 
                {% if form.task.errors %}
                <div class="form-error">{{ form.task.errors }}</div>
                {% endif %}
            </div>
            
            <!-- Duration input -->
            <div class="form-group">
                {{ form.duration.label_tag }} 
                {{ form.duration }} 
                {% if form.duration.errors %}
                <div class="form-error">{{ form.duration.errors }}</div>
                {% endif %}
            </div>
            
            <button type="submit" class="btn btn-outline-default btn-sm">
                <i class="fas fa-plus"></i> Add Task
            </button>
        </form>
    </div>
    
    <!-- Action buttons -->
    <div class="form-actions">
        {% if tasks %}
        <form action="{% url 'routine:save' %}" method="post" class="save-form">
            {% csrf_token %} 
            <input type="hidden" name="routine_name" value="{{ routine_name }}" />
            <button type="submit" class="btn btn-outline-default btn-sm">
                <i class="fas fa-save"></i> Save Routine
            </button>
        </form>
        
        <form id="start-routine-form" action="{% url 'routine:start_builder' %}" method="post" class="start-form">
            {% csrf_token %}
            <input type="hidden" name="redirect_to_timer" value="true" />
            <input type="hidden" name="routine_name" value="{{ routine_name }}" />
            <button type="submit" class="btn btn-outline-default btn-sm">
                <i class="fas fa-play"></i> Start Routine
            </button>
        </form>
        {% else %}
        <div class="no-tasks-message">
            <p>Add at least one task to save or start your routine.</p>
        </div>
        {% endif %}
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'routine/js/builder.js' %}" defer></script>
<script>
// Real-time routine name update
document.addEventListener('DOMContentLoaded', function() {
    const routineNameInput = document.getElementById('routine-name');
    const previewName = document.getElementById('preview-routine-name');
    
    if (routineNameInput && previewName) {
        routineNameInput.addEventListener('input', function() {
            previewName.textContent = this.value || 'New Routine';
        });
    }
    
    // Auto-focus on task input after page load
    const taskInput = document.querySelector('input[name="task"]');
    if (taskInput && !routineNameInput.value) {
        routineNameInput.focus();
    } else if (taskInput) {
        taskInput.focus();
    }
});

// Remove task function
function removeTask(taskIndex) {
    if (confirm('Remove this task?')) {
        // Create a form to submit the removal
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '{% url "routine:remove" %}';
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = '{{ csrf_token }}';
        
        const taskIndexInput = document.createElement('input');
        taskIndexInput.type = 'hidden';
        taskIndexInput.name = 'task_index';
        taskIndexInput.value = taskIndex;
        
        form.appendChild(csrfToken);
        form.appendChild(taskIndexInput);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}